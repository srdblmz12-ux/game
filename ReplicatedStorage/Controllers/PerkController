-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CollectionService = game:GetService("CollectionService")
local Players = game:GetService("Players")

-- Variables
local Packages = ReplicatedStorage:WaitForChild("Packages")
local Common = ReplicatedStorage:WaitForChild("Common")

local MurdererSkills = Common:WaitForChild("MurdererSkills")
local SurvivorSkills = Common:WaitForChild("SurvivorSkills")

local Signal = require(Packages:WaitForChild("Signal"))
local Trove = require(Packages:WaitForChild("Trove"))
local Net = require(Packages:WaitForChild("Net"))

local TagKey = "PerkTool"

-- Module
local PerkController = {
	Name = script.Name,
	
	CachedPerks = {},
	ActivePerks = {},
	Network = {
		PerkList = Net:RemoteEvent("SkillList"),
		PerkAssigned = Net:RemoteEvent("PerkAssigned"),
		PerkActivated = Net:RemoteEvent("PerkActivated"),
	},
}

function PerkController:OnStart()
	-- Perk Manager
	local function CacheSkill(SkillModule : ModuleScript)
		if (not SkillModule:IsA("ModuleScript")) then return end
		
		local Success, Response = pcall(require, SkillModule)
		if (Success) then
			local PerkTrove = Trove.new()
			Response.Trove = PerkTrove
			Response.Id = SkillModule.Name
			
			return Response
		else
			warn(`Skill req failed: {Response}`)
			return
		end
	end
	
	local function FetchTableAndSave(Table : {Instance}, ReferenceTable : {})
		for _,Perk in ipairs(Table) do
			ReferenceTable[Perk.Name] = CacheSkill(Perk)
		end
	end
	
	FetchTableAndSave(MurdererSkills.Skills:GetChildren(), self.CachedPerks.MurdererPerks)
	FetchTableAndSave(SurvivorSkills:GetChildren(), self.CachedPerks.SurvivorPerks)
	
	-- Perk Tracker
	
	local function PerkAdded()
		
	end
	
	local function PerkRemoved()
		
	end
	
	for _,PerkTool in ipairs(CollectionService:GetTagged(TagKey)) do
		PerkAdded()
	end
	CollectionService:GetInstanceAddedSignal(TagKey):Connect(PerkAdded)
	CollectionService:GetInstanceRemovedSignal(TagKey):Connect(PerkRemoved)
	self.Network.PerkAssigned.OnClientEvent:Connect(function(Perk : {Name : string, Id : string}?)
		if (Perk == nil) then
			PerkRemoved()
		else
			PerkAdded()
		end
	end)
end

return PerkController
